import{initializeApp}from"https://www.gstatic.com/firebasejs/9.4.1/firebase-app.js";import{getFirestore,collection,getDocs,doc,getDoc,setDoc,updateDoc,deleteDoc,deleteField}from"https://www.gstatic.com/firebasejs/9.4.1/firebase-firestore.js";import{getStorage,ref,listAll,getMetadata,getDownloadURL,uploadBytes,deleteObject,uploadBytesResumable}from"https://www.gstatic.com/firebasejs/9.4.1/firebase-storage.js";import{getAuth,signInWithEmailAndPassword,signOut}from"https://www.gstatic.com/firebasejs/9.4.1/firebase-auth.js";import Highcharts from"https://code.highcharts.com/es-modules/masters/highcharts.src.js";import"https://code.highcharts.com/es-modules/masters/modules/data.src.js";(async()=>{var fbc=await fetch(`${"sample"==location.pathname.split("/")[1]?"/sample":""}/fbc.json`),fbc=await fbc.json();initializeApp(fbc),window.db=getFirestore(),window.st=getStorage(),window.$=document.querySelector.bind(document),window.$$=document.querySelectorAll.bind(document),HTMLElement.prototype.$=HTMLElement.prototype.querySelector,HTMLElement.prototype.$$=HTMLElement.prototype.querySelectorAll,FileList.prototype.forEach=Array.prototype.forEach;const auth=getAuth(),ls=localStorage,ss=sessionStorage,de=decodeURI,en=encodeURI;window.fb={srce:"",html:"",dict:"",user:"",from:{},img:{},csv:{}};const is={sample:fbc.authDomain.includes("sample")?"/sample":"",code:en("</code>"),csv:RegExp(".csv"),img:RegExp(".gif|.png|.jpg|.jpeg|.pdf|.webp"),vid:RegExp(".mp4|.mov")},head=document.head,body=document.body,trv_opt=e=>({autosize:!0,symbol:e,interval:"D",theme:"dark",locale:"kr",enable_publishing:!1,save_image:!1,container_id:e,hide_top_toolbar:!0});null==ls.cMode&&(ls.cMode=1),document.documentElement.setAttribute("cMode",ls.cMode);const css_load=`z-index:5; position: fixed; width:100%; height:100%; background: ${"1"==ls.cMode?"#0d1117":"#fff"}; left:0; top:0; transition:ease .5s`,css_gif="position:absolute; width:100px; height:100px; top:calc(50% - 50px); left:calc(50% - 50px);";body.innerHTML=`<load style="${css_load}"><img src='${is.sample}/load_${is.sample?"main":"1"==ls.cMode?"dark":"light"}.gif' style="${css_gif}"></load>`,body.innerHTML+="<nav></nav><section><article></article></section><aside></aside><clip></clip>",document.title=is.sample.length?"불로구":"블로그";const nav=$("nav"),section=$("section"),aside=$("aside"),clip=$("clip"),u={},kb=1024;var article,url;function unload(){$("load")&&($("load").style.opacity=0,setTimeout(()=>{$("load").remove()},500))}function fval(src,asy=!0){fetch(src).then(e=>e.text()).then(r=>eval(asy?`(async()=>{${r}})()`:r))}function getData(e){if(fb.dict){if(url[2]in fb.dict){var t=fb.dict[url[2]][e];return ls.prp=t.includes(is.code),de(t)}return de(fb.srce.create.true)}return de(fb.srce.create.true)}function setScript(script){script.forEach(scr=>{scr.src?fval(scr.src,!1):eval(scr.innerText)})}function setData(e){var t=document.createElement("html");t.innerHTML=e.replaceAll(" "," ");var i=t.$$("script[src]"),a=t.$$("script:not([src])");i.forEach(e=>{e.remove()}),a.forEach(e=>{e.remove()}),article.innerHTML=t.innerHTML,setIndex(),setMenu(),setFold(),setImage(),setScript(a),setCode(),setChart(),location.hash&&(location.href=location.hash),section.classList.remove("e-s"),article.classList.remove("e-a"),clip.classList.remove("clip")}function setMenu(){$("from")&&$$("from").forEach(async e=>{var t=e.getAttribute("name").toLowerCase();if(e.onclick=(()=>{e.classList.toggle("view")}),t in fb.from)var i=fb.from[t];else(i=await getDoc(doc(db,"from",t)))&&(i=i.data())?(i=de(i.index.true),fb.from[t]=i):e.innerHTML=t;var a=document.createElement("div");a.classList.add("from"),a.innerHTML=i;var n=a.$("h1");n&&(n.remove(),n=n.innerHTML),e.innerHTML=`<a href=${is.sample}/from/${t}/><b>${n||e.innerHTML}</b></a>`,e.after(a)}),$("pubchem")&&$$("pubchem").forEach(e=>{var t=e.getAttribute("type"),i=e.getAttribute("name");i||(i=url[1]),t||(t="3D-Conformer");var a=document.createElement("iframe");a.src=`https://pubchem.ncbi.nlm.nih.gov/compound/${i}#section=${t}&embed=true`,e.append(a)})}function setFold(){if($("h1")){var e=$("h1").dataset.fold,t=$("h1").dataset.blind;$$(`article>*:not(index) ${e}, article>${e}`).forEach(e=>{e.onclick=(()=>{e.classList.toggle("fold")}),e.classList.add("foldable")}),$$(`article>*:not(index) ${t}, article>${t}`).forEach(e=>{e.classList.add("blind")})}}function setCode(){if(ls.prp&&$("code")){var e=document.createElement("button");e.innerText="Compile",e.onclick=(()=>{var e=document.createElement("form"),t=document.createElement("textarea");t.name="initScript",t.value=$("code").innerText.trim().replaceAll(" "," "),e.action="https://www.jdoodle.com/api/redirect-to-post/c-online-compiler",e.method="POST",e.target="_blank",e.append(t),article.append(e),e.submit()}),article.append(e)}}u.prp="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js",u.trv="https://s3.tradingview.com/tv.js",head.innerHTML+='<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, user-scalable=no" />',head.innerHTML+=`<link rel="shortcut icon" type="image/x-icon" href="${is.sample.length?"/sample/main.png":"/title.gif"}"/>`,null==ss.mchangeWidth&&(ss.mchangeWidth=0),null==ls.clipBoard&&(ls.clipBoard=JSON.stringify({index:0})),clip.onclick=(()=>{clip.classList.toggle("clip")}),(async()=>{url=de(location.pathname).toLowerCase().split("/").slice(1).filter(e=>""!==e),is.sample.length&&"sample"==url[0]&&(url=url.slice(1)),url.push("index","index","index"),url=url.slice(0,3),is.lazyload="life"==url[0],section.classList.add(url[0]),console.log(url),loadStorage();for(var e=JSON.parse(ls.clipBoard),t=0;t<5;t++){var i=(e.index+t)%5;if(null!=e[i]){var a=document.createElement("p");a.innerText=e[i],clip.append(a)}}clip.childNodes.forEach(e=>{e.onclick=(()=>{navigator.clipboard.writeText(e.innerText)})}),ls.edit=!0,null==ls.uid&&(ls.log=!1,ls.uid=null),fval(u.trv),fb.srce=await getDoc(doc(db,is.sample.length?"sample":"index","source")),fb.srce=fb.srce.data(),fb.user=await getDoc(doc(db,"user",ls.uid)),fb.user=fb.user.data(),head.innerHTML+=de(fb.srce.css.true),fb.user?(nav.innerHTML=de(fb.srce.nav[ls.log]),aside.innerHTML=de(fb.srce.aside[ls.log]),"null"!=ls.uid&&"undefined"!=ls.uid&&($("aside>p").innerHTML=auth.currentUser.email)):(body.innerHTML="",signout()),$("nav>div>span").onclick=(e=>{ls.cMode=1-ls.cMode,document.documentElement.setAttribute("cMode",ls.cMode)}),fb.html=doc(db,url[0],url[1]),fb.dict=await getDoc(fb.html),fb.dict=fb.dict.data()})().then(()=>{for(var e=document.createElement("portal"),t=0;t<url.length;t++)"index"!=url[t]&&(e.innerHTML+=`/<a href=/${url.slice(0,t+1).join("/")}/>${url[t]}</a>`);section.append(e),section.innerHTML+=de(fb.srce.es[fb.user.auth]),article=$("article"),setData(getData(ls.log)),unload(),ls.prp&&fval(u.prp),head.innerHTML+=de(fb.srce.prps[ls.prp])}).then(()=>{document.onkeydown=(e=>{e.ctrlKey&&69==e.keyCode&&(e.preventDefault(),edit())})}).catch(e=>{throw unload(),$("article").innerText=`\n${e.stack}\n\n${$("script[type=module]").src}`,e});var H="",s={2:["","."],3:["",")"],4:["",""],5:["(",")"]},hnum={2:"",3:"",4:"",5:""},hid={1:"",2:"",3:"",4:"",5:""},autosave,autostop;function indexing(e,t,i){var a=H[i].tagName[1];if(H[i].tid=s[a][0]+t+s[a][1],H[i].id=e+H[i].tid,i<H.length-1){var n=H[i+1].tagName[1];a<n?(hnum[a]=t,hid[a]=H[i].tid,indexing(e+hid[a],1,i+1)):a==n?indexing(e,t+1,i+1):indexing(Object.values(hid).slice(0,n-1).join(""),hnum[n]+1,i+1)}}function setIndex(){if(H=$$("h2, h3, h4, h5"),$("index")){var e="";H.length&&(indexing("",1,0),H.forEach(t=>{e+=`<${t.tagName}><a href="#${t.id}">${t.tid}</a> ${t.innerText}</${t.tagName}>`,t.innerHTML=`<a href="#">${t.tid}</a> `+t.innerHTML})),$("index").innerHTML=e}}function loadStorage(){listAll(ref(st,url.join("/"))).then(e=>{e&&e.items.forEach(async e=>{getMetadata(e).then(t=>{e.meta=t}),is.lazyload||getDownloadURL(e).then(t=>{e.src=t}),is.vid.test(e.name)||is.img.test(e.name)?fb.img[e.name]=e:is.csv.test(e.name)&&(fb.csv[e.name]=e)})}).catch(e=>{unload();var t=document.createElement("exc");throw t.className="fa fa-image r",section.prepend(t),e})}function setImage(){$$("article img").forEach(e=>{e.outerHTML=`<figure>${e.outerHTML}<figcaption>${e.getAttribute("title")}</figcaption></figure>`}),$$("article img").forEach(e=>{e.onclick=(()=>{e.classList.toggle("show"),body.classList.toggle("blur")})}),$$("blind, .blind").forEach(e=>{var t=e.nextElementSibling;e.onclick=(async()=>{t.src||t.name in fb.img&&(t.src=await getDownloadURL(fb.img[t.name])),t.childNodes.forEach(async e=>{e.src||e.name in fb.img&&(e.src=getDownloadURL(fb.img[e.name]))}),e.classList.toggle("view")})}),is.lazyload||Object.values(fb.img).forEach(async e=>{var t=$(`*[name="${e.name}"]`);if(t&&(e.src?t.src=e.src:(e.src=await getDownloadURL(fb.img[e.name]),t.src=e.src),"iframe"==t.tagName.toLowerCase())){t.setAttribute("scrolling","no");var i=document.createElement("div"),a=document.createElement("full");i.innerHTML=t.outerHTML,a.className="fa fa-expand",a.onclick=(()=>{i.firstChild.classList.toggle("show"),body.classList.toggle("blur")}),i.append(a),i.style.position="relative",i.style.width="fit-content",t.replaceWith(i)}})}function createFile(e){var t=e.name,i=document.createElement("p"),a=document.createElement("span"),n=document.createElement("size"),r=document.createElement("button");return i.setAttribute("name",t),fb.dict&&de(fb.dict[url[2]].true).includes(t)&&i.classList.add("exist"),a.onclick=(()=>{is.vid.test(t)?navigator.clipboard.writeText(`<video autoplay muted name="${t.trim()}">`):is.img.test(t)?navigator.clipboard.writeText(`<img name="${t.trim()}">`):is.csv.test(t)&&navigator.clipboard.writeText(`<chart type=line name=${t.trim()}></chart>`),i.classList.add("exist")}),a.innerText=t,r.onclick=(()=>{confirm("삭제하시겠습니까?")&&deleteObject(ref(st,`${url.join("/")}/${t}`)).then(()=>{i.remove(),delete fb.csv[t],delete fb.img[t],setFileStatus()})}),r.className="fa fa-trash",e.meta?n.innerText=numByte(e.meta.size):n.innerHTML="<bar></bar>",i.append(a,n,r),i}function numByte(e){return e>kb*kb?(e/(kb*kb)).toFixed(2)+" MB":e>kb?(e/kb).toFixed(2)+" KB":e.toFixed(2)+" B"}function uploadFile(){$("article input").files.forEach(e=>{uploadBytes(ref(st,`${url.join("/")}/${e.name}`),e).then(t=>{$("#img>div").prepend(createFile(e));var i=t.metadata.ref;i.meta=t.metadata,is.csv.test(i.name)?fb.csv[i.name]=i:fb.img[i.name]=i,setFileStatus()})}),$("article input").value=""}function clipbImg(e=!0){$("edit img")&&($$("edit img").forEach(e=>{null==fb.img[e.name]?e.removeAttribute("name"):e.src!=fb.img[e.name].src?e.removeAttribute("name"):e.src||e.removeAttribute("name")}),$$("edit img").forEach(t=>{if(!t.name){for(var i=0;i<=Object.keys(fb.img).length;i++)if(null==fb.img[`img${i}.png`]){var a=`img${i}.png`;t.setAttribute("name",a),$("#img>div").append(createFile(t));break}fetch(t.src).then(e=>e.blob()).then(i=>{var a=ref(st,`${url.join("/")}/${t.name}`),n=uploadBytesResumable(a,i),r=$(`*[name="${t.name}"]>size`);r.classList.add("p");var s=$(`*[name="${t.name}"]>size>bar`);e&&n.on("state_changed",e=>{var t=(e.bytesTransferred/e.totalBytes*100).toFixed(2)+"%";s.style.width=t,s.innerText=t}),n.then(e=>{a.meta=e.metadata,r.classList.remove("p"),r.innerText=numByte(a.meta.size),getDownloadURL(a).then(e=>{setFileStatus(),a.src=e,$(`*[name="${t.name}"]`).src=a.src}).then(()=>{t.src=fb.img[t.name].src;var e=t.parentNode;e.onclick=(()=>{e.innerText?e.innerHTML=e.innerText:e.innerText=e.innerHTML})}),fb.img[t.name]=a})})}e||(t.removeAttribute("src"),t.parentNode.innerText=t.parentNode.innerHTML)}))}function csvParse(e,t=","){for(var i,a=new RegExp("(\\"+t+'|\\r?\\n|\\r|^)(?:"([^"]*(?:""[^"]*)*)"|([^"\\'+t+"\\r\\n]*))","gi"),n=[[]];i=a.exec(e);){var r,s=i[1];s.length&&s!==t&&n.push([]),r=i[2]?i[2].replace(new RegExp('""',"g"),'"'):i[3],n[n.length-1].push(r)}return n}function setChart(){Object.values(fb.csv).forEach(async e=>{var t=$(`*[name="${e.name}"]`);if(t){t.parentElement.clientWidth;if(t.id=e.name,e=await getDownloadURL(e),e=await fetch(e),e=await e.text(),"TBL"==t.tagName){for(var i=csvParse(e),a=document.createElement("table"),n=i[0].length,r=0;r<i.length;r++){for(var s=document.createElement("tr"),l=0;l<n;l++)s.innerHTML+=`<t${0==r||0==l?"h":"d"}>${i[r][l]}</t${0==r||0==l?"h":"d"}>`;a.append(s)}t.append(a)}else{var c={chart:{},title:{},data:{},legend:{enabled:!1,layout:"vertical",align:"right"},plotOptions:{series:{dataLabels:{enabled:!0}},column:{stacking:"normal",dataLabels:{enabled:!0}},pie:{dataLabels:{enabled:!0,distance:-50}}}};c.chart.type=t.getAttribute("type"),c.title.text=t.getAttribute("title"),c.data.csv=e,c.plotOptions.stacking="1"==t.getAttribute("stack")?"normal":"",Highcharts.chart(t.id,c)}}}),$$("trv").forEach(e=>{e.id=e.getAttribute("name"),new TradingView.widget(trv_opt(e.id))})}function insert_text(e,t){var i=e.getRangeAt(0),a=document.createTextNode(t);e.deleteFromDocument(),i.insertNode(a),i.setStartAfter(a),e.removeAllRanges(),e.addRange(i)}function setFileEdit(){$("#img")&&($("#img>div").innerHTML="",Object.values(fb.img).forEach(e=>{$("#img>div").append(createFile(e))}),Object.values(fb.csv).forEach(e=>{$("#img>div").append(createFile(e))}))}function setFileStatus(){$("status").innerText="";var e=document.createElement("div"),t=0;Object.keys(fb.img).length&&(t+=Object.values(fb.img).map(e=>e.meta.size).reduce((e,t)=>e+t)),Object.keys(fb.csv).length&&(t+=Object.values(fb.csv).map(e=>e.meta.size).reduce((e,t)=>e+t));var i=t/(50*kb*kb);$("status").innerText=`${numByte(t)} / 50MB (${(100*i).toFixed(1)}%)`,e.style.width=`${i*$("status").clientWidth}px`,$("status").append(e)}function edit(){body.classList.remove("blur"),$$('input[name="type"]').forEach(e=>{e.onclick=(()=>{ls.edit=e.value,$("edit").innerText=getData(e.value)})}),article.innerHTML=`<edit contenteditable=true></edit>${de(fb.srce.file.true)}`,getData(ls.edit).split(/\n/).forEach(e=>{var t=document.createElement("p");t.innerText=e;var i=document.createElement("p");if(i.innerHTML=e,i.$("img"))if(is.lazyload)$("edit").append(t);else{var a=i.$("img");a.getAttribute("name")?(a.name&&a.name in fb.img&&(a.src=fb.img[a.name].src),i.onclick=(()=>{i.innerText?i.innerHTML=i.innerText:i.innerText=i.innerHTML}),$("edit").append(i)):$("edit").append(t)}else e.length&&$("edit").append(t)}),section.classList.add("e-s"),article.classList.add("e-a"),setFileEdit(),setFileStatus();var e=setInterval(save,6e4,!0),t=setTimeout(()=>{clearInterval(e),save(0)},3e5);$("edit").focus(),$("edit").oninput=(i=>{clearTimeout(t),t=setTimeout(()=>{clearInterval(e),save(0)},3e5)}),$("edit").onkeydown=(i=>{if(i.ctrlKey&&83==i.keyCode)i.preventDefault(),save(),clearInterval(e),clearTimeout(t);else if(9==i.keyCode)i.preventDefault(),insert_text(getSelection(),"    ");else if(i.altKey&&86==i.keyCode&&/mac|iPhone|ipad|iPod/i.test(navigator.platform)){i.preventDefault();var a=getSelection().getRangeAt(0).getBoundingClientRect();clip.classList.toggle("clip"),clip.style.top=a.bottom,clip.style.left=a.right}}),/mac|iPhone|ipad|iPod/i.test(navigator.platform)&&($("edit").oncopy=addClip,$("edit").oncut=addClip),$("edit").onpaste=(()=>{setTimeout(()=>{clipbImg()},300)})}function addClip(){var e=window.getSelection().toString();if(e.length){var t=JSON.parse(ls.clipBoard),i=document.createElement("p");i.innerText=e,i.onclick=(()=>{navigator.clipboard.writeText(e)}),t[t.index]=e,t.index=(t.index+1)%5,clip.append(i),clip.childNodes.length>5&&clip.firstChild.remove(),ls.clipBoard=JSON.stringify(t)}}function saved(e){e||(clearInterval(autosave),clearTimeout(autostop),section.classList.remove("e-s"),article.classList.remove("e-a"),setData(de(fb.dict[url[2]][ls.edit])),ls.prp&&fval(u.prp,!1)),$("es>div>span").className="b",setTimeout(()=>{$("es>div>span").className=""},1e3)}function save(e=!1){if($("edit")){clipbImg(e);var t=en($("edit").innerText);t=t.replaceAll("&alpha;","α").replaceAll("&beta;","β").replaceAll("&gamma;","γ").replaceAll("&delta;","δ"),null==fb.dict?(fb.dict={},fb.dict[url[2]]={auth:1,true:t,false:""},setDoc(fb.html,fb.dict).then(()=>{saved(e)})):(fb.dict[url[2]]||(fb.dict[url[2]]={auth:1}),fb.dict[url[2]][ls.edit]=t,1==fb.dict[url[2]].auth&&(fb.dict[url[2]][!ls.edit]=""),updateDoc(fb.html,fb.dict).then(()=>{saved(e)}))}}function del(){if(confirm("삭제하시겠습니까?")){if(clearInterval(autosave),clearTimeout(autostop),fb.dict){delete fb.dict[url[2]];var e={};e[url[2]]=deleteField(),updateDoc(fb.html,e).then(()=>{setData(getData(ls.log))}),Object.keys(fb.dict).length||(deleteDoc(fb.html),fb.dict=void 0)}else setData(getData(ls.log));listAll(ref(st,url.join("/"))).then(e=>{e&&(e.items.forEach(async e=>{deleteObject(ref(st,`${url.join("/")}/${e.name}`))}),fb.img={},fb.csv={})})}}function signin(){signInWithEmailAndPassword(auth,$("#id").value,$("#pw").value).then(e=>{ls.uid=e.user.uid,ls.log=!0,location.reload()}).catch(e=>{"invalid-email"==e.code.split("/")[1]?($(".fa-at").style.color="#e76c6c",setTimeout(()=>{$(".fa-at").style.color=""},1e3)):($(".fa-ban").style.color="#e76c6c",setTimeout(()=>{$(".fa-ban").style.color=""},1e3))})}function signout(){signOut(auth).then(()=>{alert("로그아웃 되었습니다."),location.href="/"+(is.sample?"sample":""),ls.clear(),ss.clear()}).catch(e=>{alert("로그인 정보가 없습니다.")})}window.save=save,window.edit=edit,window.del=del,window.signin=signin,window.signout=signout,window.collection=collection,window.getDocs=getDocs,window.getDoc=getDoc,window.uploadFile=uploadFile})();